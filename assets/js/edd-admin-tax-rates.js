(()=>{"use strict";var e={1669:e=>{e.exports=jQuery}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var s=t[o]={exports:{}};return e[o](s,s.exports,n),s.exports}n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),n.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var o={};n.r(o),n.d(o,{find:()=>u});var i={};n.r(i),n.d(i,{find:()=>v,findNext:()=>y,findPrevious:()=>x,isTabbableIndex:()=>g});const s=Backbone.Model.extend({defaults:{id:"",country:"",region:"",global:!0,amount:0,status:"active",unsaved:!1,selected:!1},formattedAmount:function(){let e=0;return this.get("amount")&&(e=parseFloat(this.get("amount")).toFixed(2)),`${e}%`}}),a=Backbone.Collection.extend({model:s,initialize:function(){this.showAll=!1,this.selected=[]}}),l=wp.Backbone.View.extend({template:wp.template("edd-admin-tax-rates-table-meta"),events:{'change [type="checkbox"]':"selectAll"},selectAll:function(e){const t=e.target.checked;_.each(this.collection.models,(e=>{e.set("selected",t),this.collection.selected.push(e.cid)}))}}),c=wp.Backbone.View.extend({tagName:"tr",className:"edd-tax-rate-row edd-tax-rate-row--is-empty",template:wp.template("edd-admin-tax-rates-table-row-empty")}),r=wp.Backbone.View.extend({tagName:"tr",className:function(){return"edd-tax-rate-row edd-tax-rate-row--"+this.model.get("status")},template:wp.template("edd-admin-tax-rates-table-row"),events:{"click .remove":"removeRow","click .activate":"activateRow","click .deactivate":"deactivateRow",'change [type="checkbox"]':"selectRow"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(this.template({...this.model.toJSON(),formattedAmount:this.model.formattedAmount()})),this.$el.attr("class",_.result(this,"className"))},removeRow:function(e){e.preventDefault(),this.collection.remove(this.model)},activateRow:function(e){e.preventDefault();const{i18n:t}=eddTaxRates;if(this.collection.where({region:this.model.get("region"),country:this.model.get("country"),global:""===this.model.get("region"),status:"active"}).length>0){const e=""===this.model.get("region")?"":": "+this.model.get("region"),n=this.model.get("country")+e;alert(t.duplicateRate.replace("%s",`"${n}"`))}else this.model.set("status","active")},deactivateRow:function(e){e.preventDefault(),this.model.set("status","inactive")},selectRow:function(e){e.target.checked?this.collection.selected.push(this.model.cid):this.collection.selected=_.reject(this.collection.selected,(e=>e===this.model.cid))}}),d=wp.Backbone.View.extend({tagName:"tbody",initialize:function(){this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"filtered change",this.filtered)},render:function(){if(this.views.remove(),0===this.collection.models.length)return this.views.add(new c);_.each(this.collection.models,(e=>{this.views.add(new r({collection:this.collection,model:e}))}))},filtered:function(){this.collection.where({status:"inactive"}).length!==this.collection.models.length||this.collection.showAll?this.render():this.views.add(new c)}});function h(e){return e.offsetWidth>0||e.offsetHeight>0||e.getClientRects().length>0}function u(e,{sequential:t=!1}={}){const n=e.querySelectorAll(function(e){return[e?'[tabindex]:not([tabindex^="-"])':"[tabindex]","a[href]","button:not([disabled])",'input:not([type="hidden"]):not([disabled])',"select:not([disabled])","textarea:not([disabled])",'iframe:not([tabindex^="-"])',"object","embed","area[href]","[contenteditable]:not([contenteditable=false])"].join(",")}(t));return Array.from(n).filter((e=>{if(!h(e))return!1;const{nodeName:t}=e;return"AREA"!==t||function(e){const t=e.closest("map[name]");if(!t)return!1;const n=e.ownerDocument.querySelector('img[usemap="#'+t.name+'"]');return!!n&&h(n)}(e)}))}function m(e){const t=e.getAttribute("tabindex");return null===t?0:parseInt(t,10)}function g(e){return-1!==m(e)}function f(e,t){return{element:e,index:t}}function p(e){return e.element}function b(e,t){const n=m(e.element),o=m(t.element);return n===o?e.index-t.index:n-o}function w(e){return e.filter(g).map(f).sort(b).map(p).reduce(function(){const e={};return function(t,n){const{nodeName:o,type:i,checked:s,name:a}=n;if("INPUT"!==o||"radio"!==i||!a)return t.concat(n);const l=e.hasOwnProperty(a);if(!s&&l)return t;if(l){const n=e[a];t=t.filter((e=>e!==n))}return e[a]=n,t.concat(n)}}(),[])}function v(e){return w(u(e))}function x(e){return w(u(e.ownerDocument.body)).reverse().find((t=>e.compareDocumentPosition(t)&e.DOCUMENT_POSITION_PRECEDING))}function y(e){return w(u(e.ownerDocument.body)).find((t=>e.compareDocumentPosition(t)&e.DOCUMENT_POSITION_FOLLOWING))}const k={focusable:o,tabbable:i};var N=n(1669);const S={disable_search_threshold:13,search_contains:!0,inherit_select_classes:!0,single_backstroke_delete:!1,placeholder_text_single:edd_vars.one_option,placeholder_text_multiple:edd_vars.one_or_more_option,no_results_text:edd_vars.no_results_text},T=e=>{e instanceof N||(e=N(e));let t=S;return e.data("search-type")&&delete t.disable_search_threshold,{...t,width:e.css("width")}};var C=n(1669);const R=wp.Backbone.View.extend({events:{"keydown input":"handleTabBehavior","keydown textarea":"handleTabBehavior","focus input":"onFocus","focus textarea":"onFocus","focus select":"onFocus","change input":"onChange","change textarea":"onChange","change select":"onChange","input input":"onChange","input textarea":"onChange","input select":"onChange"},preinitialize(){this.focusedEl=null,this.focusedElCaretPos=0,wp.Backbone.View.prototype.preinitialize.apply(this,arguments)},addEvents(e){this.delegateEvents({...this.events,...e})},handleTabBehavior(e){const{keyCode:t,shiftKey:n,target:o}=e;if(9!==t)return;const i=k.tabbable.find(this.el);if(!i.length)return;const s=i[0],a=i[i.length-1];let l;l=n&&o===s?a:n||o!==a?n?k.tabbable.findPrevious(o):k.tabbable.findNext(o):s,void 0!==l?(this.focusedEl=l,this.focusedElCaretPos=l.value.length):(this.focusedEl=null,this.focusedElCaretPos=0)},onFocus(e){this.focusedEl=e.target},onChange(e){const{target:t,keyCode:n}=e;if(void 0===typeof n||9!==n)try{t.selectionStart&&(this.focusedElCaretPos=t.selectionStart)}catch(e){this.focusedElCaretPos=t.value.length}},prepare(){return this.model?{...this.model.toJSON(),state:this.model.get("state").toJSON()}:{}},render(){return wp.Backbone.View.prototype.render.apply(this,arguments),this.initializeSelects(),this.setFocus(),this},initializeSelects(){const e=this.el.querySelectorAll(".edd-select-chosen");_.each(e,(e=>{C(e).chosen({...T(C(e)),width:"100%"})}))},setFocus(){const{el:e,focusedEl:t,focusedElCaretPos:n}=this;if(null==t)return;let o=null;if(""!==t.id?o=`#${t.id}`:""!==t.name?o=`[name="${t.name}"]`:t.classList.length>0&&(o=`.${[...t.classList].join(".")}`),null===o)return;const i=e.querySelector(o);if(i){i.focus();try{i.setSelectionRange&&i.setSelectionRange(n,n)}catch(e){}}}});var D=n(1669);const E=R.extend({initialize(){this.$el.dialog({position:{my:"top center",at:"center center-25%"},classes:{"ui-dialog":"edd-dialog"},closeText:edd_vars.closeText,width:"350px",modal:!0,resizable:!1,draggable:!1,autoOpen:!1,create:function(){D(this).css("maxWidth","90vw")}})},openDialog(){return this.$el.dialog("open"),this},closeDialog(e){return e&&e.preventDefault&&e.preventDefault(),this.$el.dialog("close"),this.undelegateEvents(),this}});var O=n(1669);const A=wp.Backbone.View.extend({initialize:function(e){_.extend(this,e)},render:function(){this.global||("nostates"===this.states?this.setElement('<input type="text" id="tax_rate_region" />'):(this.$el.html(this.states),this.$el.find("select").each((function(){const e=O(this);e.chosen(T(e))}))))}});var B=n(1669);const P=E.extend({tagName:"div",template:wp.template("edd-admin-tax-rates-table-dialog"),events:{"click .edd-cancel":"onCancel","submit form":"onSubmit","change #tax_rate_country":"setCountry","keyup #tax_rate_region":"setRegion","change #tax_rate_region":"setRegion",'change input[type="checkbox"]':"setGlobal","keyup #tax_rate_amount":"setAmount","change #tax_rate_amount":"setAmount"},initialize(){E.prototype.initialize.call(this),this.$el.dialog("option",{title:eddTaxRates.i18n.addNewRate,width:"350px",open:()=>{this.$el.find("select").each((function(){const e=B(this);e.chosen(T(e))})),setTimeout((()=>{B(".edd-dialog").css("overflow","visible"),B(".ui-dialog-content").css("overflow","visible")}),100)}}),this.listenTo(this.model,"change:country",this.updateRegion),this.listenTo(this.model,"change:global",this.updateRegion)},prepare(){const{model:e}=this;return{model:e.toJSON()}},updateRegion:function(){const e=this,t=this.el.querySelector("#tax_rate_region_wrapper"),n={action:"edd_get_shop_states",country:this.model.get("country"),nonce:eddTaxRates.nonce,field_name:"tax_rate_region"};B.post(ajaxurl,n,(function(n){e.views.set("#tax_rate_region_wrapper .edd-form-group__control",new A({states:n,global:e.model.get("global")})),e.model.get("global")||t.classList.remove("edd-hidden")}))},setCountry:function(e){let t=e.target.options[e.target.selectedIndex].value;const n=this.el.querySelector("#tax_rate_region_global"),o=n.querySelector("input");e.target.classList.contains("edd-select-chosen")&&(t=B(e.target).val()),"*"===t?(t="*",o.checked=!0,this.model.set("region",""),this.model.set("global",!0),n.classList.add("edd-hidden"),o.readOnly=!0,o.disabled=!0):(n.classList.remove("edd-hidden"),o.disabled=!1,o.readOnly=!1),this.model.set("country",t)},setRegion:function(e){let t=!1;t=e.target.value?e.target.value:e.target.options[e.target.selectedIndex].value,this.model.set("region",t)},setGlobal:function(e){let t=e.target.checked;const n=this.el.querySelector("#tax_rate_region_wrapper");this.model.set("global",t),!0===t&&(this.model.set("region",""),n.classList.add("edd-hidden"))},setAmount:function(e){this.model.set("amount",e.target.value)},onCancel(e){e.preventDefault(),this.closeDialog()},onSubmit(e){e.preventDefault();const{i18n:t}=eddTaxRates;if(!this.model.get("country"))return void alert(t.emptyCountry);let n=this.model.get("region"),o=this.model.get("country"),i=""===this.model.get("region");if("*"===o&&(o="",n="",i=!1),this.collection.where({region:n,country:o,global:i,status:"active"}).length>0){const e=(""===o?"*":o)+(""===n?"":": "+n);alert(t.duplicateRate.replace("%s",`"${e}"`))}else this.model.get("amount")<0?alert(t.negativeTax):(0==this.model.get("amount")&&confirm(t.emptyTax),this.collection.add(_.extend(this.model.attributes,{id:this.model.cid})),this.model=new s({global:!0,unsaved:!0}),this.closeDialog())}}),$=E.extend({tagName:"tfoot",template:wp.template("edd-admin-tax-rates-table-footer"),events:{"click button":"onAdd"},onAdd(e){e.preventDefault();const t=new s({global:!0,unsaved:!0});new P({model:t,collection:this.collection}).render().openDialog()}}),I=wp.Backbone.View.extend({tagName:"table",className:"wp-list-table widefat fixed tax-rates",id:"edd_tax_rates",render:function(){this.views.add(new l({tagName:"thead",collection:this.collection})),this.views.add(new d({collection:this.collection})),this.views.add(new $({collection:this.collection})),this.views.add(new l({tagName:"tfoot",collection:this.collection})),this.collection.trigger("filtered")}}),z=wp.Backbone.View.extend({template:wp.template("edd-admin-tax-rates-table-bulk-actions"),events:{"click .edd-admin-tax-rates-table-filter":"filter","change .edd-admin-tax-rates-table-hide input":"showHide"},filter:function(e){e.preventDefault();const t=document.getElementById("edd-admin-tax-rates-table-bulk-actions");_.each(this.collection.selected,(e=>{this.collection.get({cid:e}).set("status",t.value)})),this.collection.trigger("filtered")},showHide:function(e){this.collection.showAll=e.target.checked,document.getElementById("edd_tax_rates").classList.toggle("has-inactive",this.collection.showAll),this.collection.trigger("filtered")}}),L=wp.Backbone.View.extend({el:"#edd-admin-tax-rates",initialize:function(){this.listenTo(this.collection,"add change",this.makeDirty),document.querySelector(".edd-settings-form #submit").addEventListener("click",this.makeClean)},render:function(){this.views.add(new z({collection:this.collection})),this.views.add(new I({collection:this.collection}))},makeDirty:function(){window.onbeforeunload=this.confirmUnload},makeClean:function(){window.onbeforeunload=null},confirmUnload:function(e){return e.preventDefault(),""}});var V,j=n(1669);V=()=>{const e=document.getElementById("edd-tax-disabled-notice");e&&(e.classList.add("notice"),e.classList.add("notice-warning"));const t=new L({collection:new a}),n=[];_.each(eddTaxRates.rates,(e=>n.push({id:e.id,country:e.country,region:e.state,global:"country"===e.scope,amount:e.amount,status:e.status}))),t.collection.set(n,{silent:!0}),t.render()},function(e){e(V)}(j)})();