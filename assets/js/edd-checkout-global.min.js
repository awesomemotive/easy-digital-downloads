function recalculate_taxes(a){if("1"==edd_global_vars.taxes_enabled){var b=jQuery("#edd_cc_address");a||(a=b.find("#card_state").val());var c={action:"edd_recalculate_taxes",billing_country:b.find("#billing_country").val(),state:a,card_zip:b.find("input[name=card_zip]").val()},d=++ajax_tax_count;jQuery.ajax({type:"POST",data:c,dataType:"json",url:edd_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(a){if(d===ajax_tax_count){jQuery("#edd_checkout_cart_form").replaceWith(a.html),jQuery(".edd_cart_amount").html(a.total);var b=new Object;b.postdata=c,b.response=a,jQuery("body").trigger("edd_taxes_recalculated",[b])}}}).fail(function(a){window.console&&window.console.log&&(console.log(a),d===ajax_tax_count&&jQuery("body").trigger("edd_taxes_recalculated",[tax_data]))})}}window.EDD_Checkout=function(a){"use strict";function b(){g=a(document.body),h=a("#edd_purchase_form"),i=a(".edd_cart_amount"),j=i.text(),k=a("#edd_checkout_form_wrap"),g.on("keyup change",".edd-do-validate .card-number",function(){c(a(this))}),g.on("submit","#edd_payment_mode",function(){var b=a("#edd-gateway option:selected").val();if(0==b)return alert(edd_global_vars.no_gateway),!1}),g.on("click","#edd_payment_mode_select input",function(){a("#edd_payment_mode_select label.edd-gateway-option-selected").removeClass("edd-gateway-option-selected"),a("#edd_payment_mode_select input:checked").parent().addClass("edd-gateway-option-selected")}),k.on("click",".edd-apply-discount",d),k.on("keypress","#edd-discount",function(a){if("13"==a.keyCode)return!1}),k.on("keyup","#edd-discount",function(a){"13"==a.keyCode&&k.find(".edd-apply-discount").trigger("click")}),g.on("click",".edd_discount_remove",e),g.on("click",".edd_discount_link",function(b){b.preventDefault(),a(".edd_discount_link").parent().hide(),a("#edd-discount-code-wrap").show().find("#edd-discount").focus()}),g.find("#edd-discount-code-wrap").hide(),g.find("#edd_show_discount").show(),g.on("change",".edd-item-quantity",f),g.on("click",".edd-amazon-logout #Logout",function(a){a.preventDefault(),amazon.Login.logout(),window.location=edd_amazon.checkoutUri})}function c(b){var c=b;c.validateCreditCard(function(b){var d=a(".card-type");null==b.card_type?(d.removeClass().addClass("off card-type"),c.removeClass("valid"),c.addClass("error")):(d.removeClass("off"),d.addClass(b.card_type.name),b.length_valid&&b.luhn_valid?(c.addClass("valid"),c.removeClass("error")):(c.removeClass("valid"),c.addClass("error")))})}function d(b){b.preventDefault();var c=(a(this),a("#edd-discount").val()),d=a("#edd-discount-loader");if(""==c||c==edd_global_vars.enter_discount)return!1;var e={action:"edd_apply_discount",code:c,form:a("#edd_purchase_form").serialize()};return a("#edd-discount-error-wrap").html("").hide(),d.show(),a.ajax({type:"POST",data:e,dataType:"json",url:edd_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(b){if(b)if("valid"==b.msg){a(".edd_cart_discount").html(b.html),a(".edd_cart_discount_row").show(),a(".edd_cart_amount").each(function(){a(this).text(b.total)}),a("#edd-discount",k).val(""),recalculate_taxes();var c=a("#edd_cc_fields .edd-input, #edd_cc_fields .edd-select,#edd_cc_address .edd-input, #edd_cc_address .edd-select,#edd_payment_mode_select .edd-input, #edd_payment_mode_select .edd-select");"0.00"==b.total_plain?(a("#edd_cc_fields,#edd_cc_address,#edd_payment_mode_select").slideUp(),c.removeAttr("required"),a('input[name="edd-gateway"]').val("manual")):(c.is(".card-address-2")||c.attr("required","required"),a("#edd_cc_fields,#edd_cc_address").slideDown()),g.trigger("edd_discount_applied",[b])}else a("#edd-discount-error-wrap").html('<span class="edd_error">'+b.msg+"</span>"),a("#edd-discount-error-wrap").show(),g.trigger("edd_discount_invalid",[b]);else window.console&&window.console.log&&console.log(b),g.trigger("edd_discount_failed",[b]);d.hide()}}).fail(function(a){window.console&&window.console.log&&console.log(a)}),!1}function e(b){var c=a(this),d={action:"edd_remove_discount",code:c.data("code")};return a.ajax({type:"POST",data:d,dataType:"json",url:edd_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(b){var c="0"+edd_global_vars.decimal_separator+"00";a(".edd_cart_amount").each(function(){edd_global_vars.currency_sign+c!=a(this).text()&&c+edd_global_vars.currency_sign!=a(this).text()||window.location.reload(),a(this).text(b.total)}),a(".edd_cart_discount").html(b.html),b.discounts||a(".edd_cart_discount_row").hide(),recalculate_taxes(),a("#edd_cc_fields,#edd_cc_address").slideDown(),g.trigger("edd_discount_removed",[b])}}).fail(function(a){window.console&&window.console.log&&console.log(a)}),!1}function f(b){var c=a(this),d=c.val(),e=c.data("key"),f=c.closest(".edd_cart_item").data("download-id"),h=c.parent().find('input[name="edd-cart-download-'+e+'-options"]').val(),i={action:"edd_update_quantity",quantity:d,download_id:f,options:h};return a.ajax({type:"POST",data:i,dataType:"json",url:edd_global_vars.ajaxurl,xhrFields:{withCredentials:!0},success:function(b){a(".edd_cart_subtotal_amount").each(function(){a(this).text(b.subtotal)}),a(".edd_cart_tax_amount").each(function(){a(this).text(b.taxes)}),a(".edd_cart_amount").each(function(){a(this).text(b.total),g.trigger("edd_quantity_updated",[b])})}}).fail(function(a){window.console&&window.console.log&&console.log(a)}),!1}var g,h,i,j,k;return{init:b,recalculate_taxes:recalculate_taxes}}(window.jQuery),window.jQuery(document).ready(EDD_Checkout.init);var ajax_tax_count=0;
