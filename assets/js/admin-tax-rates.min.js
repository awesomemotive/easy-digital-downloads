var eddTaxRatesChosenVars={disable_search_threshold:13,search_contains:!0,inherit_select_classes:!0,single_backstroke_delete:!1,placeholder_text_single:edd_vars.one_option,placeholder_text_multiple:edd_vars.one_or_more_option,no_results_text:edd_vars.no_results_text},TaxRate=Backbone.Model.extend({defaults:{id:"",country:"",region:"",global:!0,amount:0,status:"active",unsaved:!1,selected:!1},formattedAmount:function(){var amount=0;return this.get("amount")&&(amount=parseFloat(this.get("amount")).toFixed(2)),amount+"%"}}),TaxRates=Backbone.Collection.extend({model:TaxRate,initialize:function(){this.showAll=!1,this.selected=[]}}),TaxRatesTableEmpty=wp.Backbone.View.extend({tagName:"tr",className:"edd-tax-rate-row edd-tax-rate-row--is-empty",template:wp.template("edd-admin-tax-rates-table-row-empty")}),TaxRatesTableRow=wp.Backbone.View.extend({tagName:"tr",className:function(){return"edd-tax-rate-row edd-tax-rate-row--"+this.model.get("status")},template:wp.template("edd-admin-tax-rates-table-row"),events:{"click .remove":"removeRow","click .activate":"activateRow","click .deactivate":"deactivateRow",'change [type="checkbox"]':"selectRow"},initialize:function(){this.listenTo(this.model,"change",this.render)},render:function(){this.$el.html(this.template(_.extend(this.model.toJSON(),{formattedAmount:this.model.formattedAmount()}))),this.$el.attr("class",_.result(this,"className"))},removeRow:function(event){event.preventDefault(),this.collection.remove(this.model)},activateRow:function(event){event.preventDefault(),this.model.set("status","active")},deactivateRow:function(event){event.preventDefault(),this.model.set("status","inactive")},selectRow:function(event){var self=this;event.target.checked?this.collection.selected.push(this.model.cid):this.collection.selected=_.reject(this.collection.selected,function(cid){return cid===self.model.cid})}}),TaxRatesTableRows=wp.Backbone.View.extend({tagName:"tbody",initialize:function(){this.listenTo(this.collection,"add",this.render),this.listenTo(this.collection,"remove",this.render),this.listenTo(this.collection,"filtered change",this.filtered)},render:function(){var self=this;if(this.views.remove(),0===this.collection.models.length)return this.views.add(new TaxRatesTableEmpty);_.each(this.collection.models,function(rate){self.views.add(new TaxRatesTableRow({collection:self.collection,model:rate}))})},filtered:function(){this.collection.where({status:"inactive"}).length!==this.collection.models.length||this.collection.showAll?this.render():this.views.add(new TaxRatesTableEmpty)}}),TaxRatesTableMeta=wp.Backbone.View.extend({template:wp.template("edd-admin-tax-rates-table-meta"),events:{'change [type="checkbox"]':"selectAll"},selectAll:function(event){var self=this,checked=event.target.checked;_.each(this.collection.models,function(model){model.set("selected",checked),self.collection.selected.push(model.cid)})}}),TaxRatesTableRegion=wp.Backbone.View.extend({initialize:function(options){_.extend(this,options)},render:function(){this.global||("nostates"===this.states?this.setElement('<input type="text" id="tax_rate_region" />'):(this.$el.html(this.states),this.$el.find("select").chosen(eddTaxRatesChosenVars)))}}),TaxRatesTableAdd=wp.Backbone.View.extend({tagName:"tfoot",className:"add-new",template:wp.template("edd-admin-tax-rates-table-add"),events:{"click button":"addTaxRate","change #tax_rate_country":"setCountry","keyup #tax_rate_region":"setRegion","change #tax_rate_region":"setRegion",'change input[type="checkbox"]':"setGlobal","keyup #tax_rate_amount":"setAmount","change #tax_rate_amount":"setAmount"},initialize:function(){this.model=new TaxRate({global:!0,unsaved:!0}),this.listenTo(this.model,"change:country",this.updateRegion),this.listenTo(this.model,"change:global",this.updateRegion)},render:function(){this.$el.html(this.template()),this.$el.find("select").chosen("eddTaxRatesChosenVars")},updateRegion:function(){var self=this,data={action:"edd_get_shop_states",country:this.model.get("country"),nonce:eddTaxRates.nonce,field_name:"tax_rate_region"};$.post(ajaxurl,data,function(response){self.views.set("#tax_rate_region_wrapper",new TaxRatesTableRegion({states:response,global:self.model.get("global")}))})},setCountry:function(event){this.model.set("country",event.target.options[event.target.selectedIndex].value)},setRegion:function(event){var value=!1;value=event.target.value?event.target.value:event.target.options[event.target.selectedIndex].value,this.model.set("region",value)},setGlobal:function(event){this.model.set("global",event.target.checked)},setAmount:function(event){this.model.set("amount",event.target.value)},addTaxRate:function(event){event.preventDefault(),this.collection.add(_.extend(this.model.attributes,{id:this.model.cid})),this.render(),this.initialize()}}),TaxRatesTable=wp.Backbone.View.extend({tagName:"table",className:"wp-list-table widefat fixed tax-rates",id:"edd_tax_rates",render:function(){this.views.add(new TaxRatesTableMeta({tagName:"thead",collection:this.collection})),this.views.add(new TaxRatesTableRows({collection:this.collection})),this.views.add(new TaxRatesTableAdd({collection:this.collection})),this.views.add(new TaxRatesTableMeta({tagName:"tfoot",collection:this.collection})),this.collection.trigger("filtered")}}),TaxRatesBulkActions=wp.Backbone.View.extend({template:wp.template("edd-admin-tax-rates-table-bulk-actions"),events:{"click .edd-admin-tax-rates-table-filter":"filter","change .edd-admin-tax-rates-table-hide input":"showHide"},filter:function(event){event.preventDefault();var self=this,status=document.getElementById("edd-admin-tax-rates-table-bulk-actions");_.each(this.collection.selected,function(cid){self.collection.get({cid:cid}).set("status",status.value)}),this.collection.trigger("filtered")},showHide:function(event){this.collection.showAll=event.target.checked,document.getElementById("edd_tax_rates").classList.toggle("has-inactive",this.collection.showAll),this.collection.trigger("filtered")}}),TaxManager=wp.Backbone.View.extend({el:"#edd-admin-tax-rates",initialize:function(){this.listenTo(this.collection,"add change",this.makeDirty),document.querySelector(".edd-settings-form #submit").addEventListener("click",this.makeClean)},render:function(){this.views.add(new TaxRatesBulkActions({collection:this.collection})),this.views.add(new TaxRatesTable({collection:this.collection}))},makeDirty:function(){window.onbeforeunload=this.confirmUnload},makeClean:function(){window.onbeforeunload=null},confirmUnload:function(event){return event.preventDefault(),""}});document.addEventListener("DOMContentLoaded",function(){var eddTaxRatesManager=new TaxManager({collection:new TaxRates}),rates=[];_.each(eddTaxRates.rates,function(rate){rates.push({id:rate.id,country:rate.name,region:rate.description,global:"country"===rate.scope,amount:rate.amount,status:rate.status})}),eddTaxRatesManager.collection.set(rates,{silent:!0}),eddTaxRatesManager.render(),$(".edd-select-chosen").chosen(eddTaxRatesChosenVars)});