(()=>{"use strict";var e={1669:e=>{e.exports=jQuery}},t={};function d(a){var r=t[a];if(void 0!==r)return r.exports;var n=t[a]={exports:{}};return e[a](n,n.exports,d),n.exports}var a=d(1669),r=d(1669);function n(){if(window.eddSquare.squareData="undefined"!=typeof eddSquare?eddSquare:null,"undefined"==typeof Square)return;if(!window.eddSquare.squareData)return;window.eddSquare.cardValidation={cardNumber:!1,expirationDate:!1,postalCode:!1,cvv:!1};const e=document.getElementById("edd-purchase-button");e&&(window.eddSquare.submitButtonOriginalText=e.value);const t=document.querySelector('input[name="edd-gateway"]');t&&"square"===t.value?(window.eddSquare.singleGateway=!0,o()):(window.eddSquare.singleGateway=!1,r(document.body).on("edd_gateway_loaded",((e,t)=>{"square"===t?o():window.eddSquare.card&&window.eddSquare.card.detach()})))}async function o(){let e=document.getElementById("edd-square-card-element");if(!e)return void i("disabled");i("updating");let t=!1;window.eddSquare.card?(window.eddSquare.card.attach(e),t=!0):(window.eddSquare.payments=null,window.eddSquare.card=null,t=await async function(){if(!window.eddSquare.squareData)return!1;try{return window.eddSquare.payments=Square.payments(window.eddSquare.squareData.client_id,window.eddSquare.squareData.location_id),window.eddSquare.card=await window.eddSquare.payments.card(),await window.eddSquare.card.attach("#edd-square-card-element"),!0}catch(e){return e&&console.error("Error details:",{type:e.constructor.name,message:e.message,code:e.code,details:e.details}),l(e.message||window.eddSquare.squareData.strings&&window.eddSquare.squareData.strings.genericError||"Failed to initialize payment form."),!1}}()),t?(i("disabled"),window.eddSquare.card&&(window.eddSquare.card.addEventListener("focusClassRemoved",(async e=>{window.eddSquare.cardValidation[e.detail.field]=e.detail.currentState.isCompletelyValid,s()})),window.eddSquare.card.addEventListener("cardBrandChanged",(async e=>{window.eddSquare.cardValidation[e.detail.field]=e.detail.currentState.isCompletelyValid,s()})),window.eddSquare.card.addEventListener("errorClassAdded",(async e=>{window.eddSquare.cardValidation[e.detail.field]=!1,s()})),window.eddSquare.card.addEventListener("postalCodeChanged",(async e=>{window.eddSquare.cardValidation.postalCode=e.detail.currentState.isCompletelyValid,s()})))):i("disabled")}function i(e){const t=document.getElementById("edd-purchase-button");t&&("disabled"===e?(t.setAttribute("data-edd-button-state",e),t.setAttribute("disabled","disabled"),t.setAttribute("readonly","readonly"),t.value=window.eddSquare.squareData.strings&&window.eddSquare.squareData.strings.completePurchase||"Complete Purchase"):"processing"===e?(t.setAttribute("data-edd-button-state",e),t.setAttribute("disabled","disabled"),t.setAttribute("readonly","readonly"),t.value=window.eddSquare.squareData.strings&&window.eddSquare.squareData.strings.processing||"Processing..."):"updating"===e?(t.setAttribute("data-edd-button-state",e),t.setAttribute("disabled","disabled"),t.setAttribute("readonly","readonly"),t.value=window.eddSquare.submitButtonOriginalText||window.eddSquare.squareData.strings&&window.eddSquare.squareData.strings.completePurchase||"Complete Purchase"):"enabled"===e&&(u(),t.removeAttribute("data-edd-button-state"),t.removeAttribute("disabled"),t.removeAttribute("readonly"),t.value=window.eddSquare.submitButtonOriginalText||window.eddSquare.squareData.strings&&window.eddSquare.squareData.strings.completePurchase||"Complete Purchase"))}function s(){let e="disabled";Object.values(window.eddSquare.cardValidation).every((e=>e))&&(e="enabled"),i(e)}function u(){const e=document.getElementById("edd-purchase-button");["click","keydown"].forEach((t=>{e.addEventListener(t,c)})),function(){const e=document.getElementById("edd-purchase-button");e&&(e.disabled=!1)}()}async function c(e){if(!function(){const e=document.querySelector('input[name="edd-gateway"]');return!!e&&"square"===e.value}())return;e.preventDefault(),function(){const e=document.getElementById("edd-purchase-button");["click","keydown"].forEach((t=>{e.removeEventListener(t,c)})),function(){const e=document.getElementById("edd-purchase-button");e&&(e.disabled=!0)}()}(),w();const t=document.getElementById("edd_purchase_form"),d=document.getElementById("edd-purchase-button"),n=r("#edd-process-square-token");if(!window.eddSquare.card)return l(window.eddSquare.squareData.strings&&window.eddSquare.squareData.strings.cardError||"Card payment not initialized"),void u();i("processing");const o=document.getElementById("edd-square-loading");o&&(o.style.display="block"),w();try{let e=new FormData(t),d={};for(let[t,a]of e)d[t]=a;const r=await async function(e){const t=await window.eddSquare.card.tokenize(e);if("OK"!==t.status)throw new Error(window.eddSquare.i18n.invalid_card);return t.token}(function(e){const t=document.querySelector(".edd_cart_total .edd_cart_amount");let d="0.00";t&&(d=t.getAttribute("data-total")||d,d=parseFloat(d).toFixed(2));const a={},r={edd_last:"familyName",edd_first:"givenName",card_city:"city",card_state:"state",card_zip:"postalCode",edd_email:"email",edd_phone:"phone",billing_country:"countryCode"};for(const[t,d]of Object.entries(r))e[t]&&e[t].length>0&&(a[d]=e[t]);const n=[];return e.card_address&&n.push(e.card_address),e.card_address_2&&n.push(e.card_address_2),n.length>0&&(a.addressLines=n),{amount:d,currencyCode:window.eddSquare.currency,intent:"CHARGE",customerInitiated:!0,sellerKeyedIn:!1,billingContact:a}}(d));if(!r)return l("Failed to process card payment."),void u();let{square_payment_status:o}=await function(e,t){const d={type:"POST",dataType:"json",xhrFields:{withCredentials:!0},url:window.edd_scripts&&window.edd_scripts.ajaxurl||window.ajaxurl,data:{action:"edd_square_process_checkout_form",...t}},r=a.Deferred((function(e){e.jqXHR=a.ajax(d).done((function(t){"1"!==t&&1!==t||(t={success:!0}),"object"==typeof t&&void 0!==typeof t.success?e[t.success?"resolveWith":"rejectWith"](this,[t.data]):e.rejectWith(this,[t])})).fail((function(){e.rejectWith(this,arguments)}))})),n=r.promise();return n.abort=function(){return r.jqXHR.abort(),this},n}(0,{form_data:d,source_id:r,token:n.data("token"),timestamp:n.data("timestamp")});if("COMPLETED"!==o)return l("Payment failed. Please try again."),void u();window.location.href=eddSquare.success_page_uri}catch(e){console.log(e),u(),l(e.message||window.eddSquare.squareData.strings&&window.eddSquare.squareData.strings.genericError||"An error occurred."),d.disabled=!1,d.value=window.eddSquare.submitButtonOriginalText||window.eddSquare.squareData.strings&&window.eddSquare.squareData.strings.completePurchase||"Complete Purchase",o&&(o.style.display="none")}}function l(e){const t=document.getElementById("edd-square-card-errors"),d=document.getElementById("edd-square-card-error-message");console.log(t,d),t&&d&&(d.textContent=e,t.style.display="block",null!==t.offsetParent&&t.scrollIntoView({behavior:"smooth",block:"center"}))}function w(){const e=document.getElementById("edd-square-card-errors"),t=document.getElementById("edd-square-card-error-message");e&&t&&(t.textContent="",e.style.display="none")}(()=>{try{wp.domReady(n)}catch(e){alert(e.message)}})()})();