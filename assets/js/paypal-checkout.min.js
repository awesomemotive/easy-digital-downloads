var EDD_PayPal={isMounted:!1,init:function(){document.getElementById("edd-paypal-container")&&this.initButtons("#edd-paypal-container","checkout"),jQuery(document.body).on("edd_discount_applied",this.maybeRefreshPage),jQuery(document.body).on("edd_discount_removed",this.maybeRefreshPage)},isPayPal:function(){var chosenGateway=!1;return"paypal_commerce"===(chosenGateway=!(chosenGateway=jQuery("select#edd-gateway, input.edd-gateway").length?jQuery("meta[name='edd-chosen-gateway']").attr("content"):chosenGateway)&&edd_scripts.default_gateway?edd_scripts.default_gateway:chosenGateway)},maybeRefreshPage:function(e,data){(0===data.total_plain&&EDD_PayPal.isPayPal()||!EDD_PayPal.isMounted&&EDD_PayPal.isPayPal()&&0<data.total_plain)&&window.location.reload()},setErrorHtml:function(form,context,errorHtml){var errorWrapper;"checkout"===context&&"undefined"!=typeof edd_global_vars&&edd_global_vars.checkout_error_anchor?(errorWrapper=document.getElementById("edd-paypal-errors-wrap"))&&(errorWrapper.innerHTML=errorHtml):"buy_now"!==context||(errorWrapper=!!(form=form.closest(".edd_download_purchase_form"))&&form.querySelector(".edd-paypal-checkout-buy-now-error-wrapper"))&&(errorWrapper.innerHTML=errorHtml),jQuery(document.body).trigger("edd_checkout_error",[errorHtml])},initButtons:function(container,context){EDD_PayPal.isMounted=!0,paypal.Buttons(EDD_PayPal.getButtonArgs(container,context)).render(container),document.dispatchEvent(new CustomEvent("edd_paypal_buttons_mounted"))},getButtonArgs:function(container,context){var form="checkout"===context?document.getElementById("edd_purchase_form"):container.closest(".edd_download_purchase_form"),errorWrapper="checkout"===context?form.querySelector("#edd-paypal-errors-wrap"):form.querySelector(".edd-paypal-checkout-buy-now-error-wrapper"),spinner="checkout"===context?document.getElementById("edd-paypal-spinner"):form.querySelector(".edd-paypal-spinner"),nonceEl=form.querySelector('input[name="edd_process_paypal_nonce"]'),tokenEl=form.querySelector('input[name="edd-process-paypal-token"]'),createFunc="subscription"===eddPayPalVars.intent?"createSubscription":"createOrder",buttonArgs={onApprove:function(data,actions){var formData=new FormData;return formData.append("action",eddPayPalVars.approvalAction),formData.append("edd_process_paypal_nonce",nonceEl.value),formData.append("token",tokenEl.getAttribute("data-token")),formData.append("timestamp",tokenEl.getAttribute("data-timestamp")),data.orderID&&formData.append("paypal_order_id",data.orderID),data.subscriptionID&&formData.append("paypal_subscription_id",data.subscriptionID),fetch(edd_scripts.ajaxurl,{method:"POST",body:formData}).then(function(response){return response.json()}).then(function(responseData){if(responseData.success&&responseData.data.redirect_url)window.location=responseData.data.redirect_url;else{spinner.style.display="none";var errorHtml=responseData.data.message||eddPayPalVars.defaultError;if(EDD_PayPal.setErrorHtml(container,context,errorHtml),responseData.data.retry)return actions.restart()}})},onError:function(error){spinner.style.display="none",error.name="",EDD_PayPal.setErrorHtml(container,context,error)},onCancel:function(data){spinner.style.display="none";var formData=new FormData;return formData.append("action","edd_cancel_paypal_order"),fetch(edd_scripts.ajaxurl,{method:"POST",body:formData}).then(function(response){return response.json()}).then(function(responseData){var nonces;responseData.success&&(nonces=responseData.data.nonces,Object.keys(nonces).forEach(function(key){var gatewaySelector=document.getElementById("edd-gateway-"+key);gatewaySelector&&gatewaySelector.setAttribute("data-"+key+"-nonce",nonces[key])}))})}};return eddPayPalVars.style&&(buttonArgs.style=eddPayPalVars.style),buttonArgs[createFunc]=function(data,actions){return spinner.style.display="block",errorWrapper&&(errorWrapper.innerHTML=""),fetch(edd_scripts.ajaxurl,{method:"POST",body:new FormData(form)}).then(function(response){return response.json()}).then(function(orderData){if(orderData.data&&orderData.data.paypal_order_id)return orderData.data.nonce&&(nonceEl.value=orderData.data.nonce),orderData.data.token&&(jQuery(tokenEl).attr("data-token",orderData.data.token),jQuery(tokenEl).attr("data-timestamp",orderData.data.timestamp)),orderData.data.paypal_order_id;var errorHtml=eddPayPalVars.defaultError;return orderData.data&&"string"==typeof orderData.data?errorHtml=orderData.data:"string"==typeof orderData&&(errorHtml=orderData),new Promise(function(resolve,reject){reject(errorHtml)})})},buttonArgs}};jQuery(document.body).on("edd_gateway_loaded",function(e,gateway){"paypal_commerce"===gateway&&EDD_PayPal.init()}),jQuery(document).ready(function($){for(var buyButtons=document.querySelectorAll(".edd-paypal-checkout-buy-now"),i=0;i<buyButtons.length;i++){var wrapper,spinnerWrap=buyButtons[i];spinnerWrap.classList.contains("edd-free-download")||(wrapper=spinnerWrap.closest(".edd_purchase_submit_wrapper"))&&(wrapper.innerHTML="",(spinnerWrap=document.createElement("div")).classList.add("edd-paypal-checkout-buy-now-error-wrapper"),wrapper.before(spinnerWrap),(spinnerWrap=document.createElement("span")).classList.add("edd-paypal-spinner","edd-loading-ajax","edd-loading"),spinnerWrap.style.display="none",wrapper.after(spinnerWrap),EDD_PayPal.initButtons(wrapper,"buy_now"))}});